# IPsec

Протокол, обеспечивающий
целостность, аутентификацию источника, защиту от повторов, конфиденциальность данных
на уровне IP.

Состоит из
* AH - authentication header - целостность и аутентификацию айпи датаграмм
  без установления соединения. Аппендится новое поле в айпи пакет: MAC
* ESP - encapsulating security protocol - конфиденциальность данных.
  Заменяет весь айпи пакет целиком на шифрованный.

### ISAKMP

На одно направление соединения создаётся один SA bundle
(security association bundle),
который хранит информацию о параметрах соединения.
Звучит как деталь реализации, но видимо это важно.

Протокол установления SA называется ISAKMP,
и на самом деле это не протокол.

IKE - комбинация SKEME и Oakley - сам обмен ключами.

### SKEME

Режимы:

1. Основной режим: полный ДХ
2. На основе открытых ключей без ДХ
3. Обмен ключами на основе одновременно ДХ и уже распределённых
4. Быстрая замена ключа на симметричных алгоритмах

Фазы:

1. Shake:
```
A -> B: Eb(A, Ka)
B -> A: Ea(B, Kb)
K0 = h(Ka, Kb) - общий секрет для других фаз
```
2. EXCH:
  подписанный на К0 обмен разными параметрами. Либо параметры дх, либо нонсы.
3. AUTH - проверка подписей из фазы EXCH

### Oakley

Похож на SKEME по структуре и по tls по хэндшейку.

Фазы:
1. Обмен печеньками и договор об алгоритмах
2. Обмен параметрами ДХ (может отсутствовать)
3. Аутентификация (проверка подписей)
